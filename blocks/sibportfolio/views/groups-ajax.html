{% verbatim %}
<script id="block_sibportfolio_tmpl1" type="text/x-handlebars-template">
    {{# each sort_links }}
        <a href='{{ ../wwwroot }}/blocks/sibportfolio/groups.php?sortorder={{ sortorder }}&groupname={{ ../group_name }}'
           style='{{ style }}' class='block_sibportfolio_sortlink'>{{ caption }}</a>
        <span></span>
    {{/ each }}
</script>

<script id="block_sibportfolio_tmpl2" type="text/x-handlebars-template">
    {{# each groups }}
    <tr style='{{# ifNotVisible this }}color: #999;{{/ ifNotVisible }}'>
        <td>
            <a style='{{# ifNotVisible this }}color: #999;{{/ ifNotVisible }}'
               href='{{ ../wwwroot }}/cohort/assign.php?id={{ id }}&returnurl={{ ../return_url_local }}'>{{ name }}</a>
        </td>
        <td>
            {{# if hasCurator }}
            <span class='{{# ifNotVisible this }}block_sibportfolio_red{{/ ifNotVisible }}'>{{ curator }}</span>
            <a href='{{ ../../wwwroot }}/blocks/sibportfolio/handlers/forms/delcurator.php?groupid={{ id }}&returnurl={{ ../../return_url }}'>{{{ ../../icon_delmod }}}</a>
            {{ else }}
            {{{ ../../icon_addmod }}}
            <a style='{{# ifNotVisible this }}color: #999;{{/ ifNotVisible }}'
               href='{{ ../../wwwroot }}/blocks/sibportfolio/handlers/forms/addcurator.php?groupid={{ id }}&returnurl={{ ../../return_url }}'>{{ ../../add_curator_label }}</a>
            {{/ if }}
        </td>
        <td>{{{ speciality }}}</td>
        <td>{{{ study }}}</td>
        <td>
            {{{ ../icon_editgr }}}
            <a style='{{# ifNotVisible this }}color: #999;{{/ ifNotVisible }}'
               href='{{ ../wwwroot }}/blocks/sibportfolio/handlers/forms/editgroup.php?groupid={{ id }}&returnurl={{ ../return_url }}'>{{ ../edit_group_label }}</a>
        </td>
    </tr>
    {{/ each }}
</script>

<script id="block_sibportfolio_tmpl3" type="text/x-handlebars-template">
    {{# each pages }}
    {{# if url }}
    <form style='float: left;' action='{{ ../../wwwroot }}/blocks/sibportfolio/groups.php' method='get'>
        <input type='hidden' name='page' value='{{ caption }}' />
        <input type='hidden' name='sortorder' value='{{ ../../sortorder }}' />
        <input type='hidden' name='groupname' value='{{ ../../group_name }}' />
        <input class='block_sibportfolio_pagebtn block_sibportfolio_button' style='{{ style }}' type='submit' value='{{ caption }}'>
    </form>
    {{ else }}
    <button class='block_sibportfolio_button' style='float: left;' type='submit' disabled>..</button>
    {{/ if }}
    {{/ each }}
</script>
{% endverbatim %}

<script type="text/javascript">
    var jQuerySibport = jQuery.noConflict(true);

    jQuerySibport(document).ready(function ($) {

        var handle = false;

        var click = function (e) {
            if (!handle) handle = true;
            else return false;

            e.preventDefault();
            $("#block_sibportfolio_tablebody").empty();
            $("#block_sibportfolio_load").show();
            var target = $(e.target);
            var url = target[0].tagName == "A" ? target.attr("href") : target.parent("form").attr("action");
            var reqData = target[0].tagName == "A" ? null : target.parent("form").serialize();

            $.ajax({
                url: url,
                timeout: 60000,
                data: reqData,
                type: "get",
                dataType: "json",
                success: function (data) {
                    $("#block_sibportfolio_sortlinks").empty();
                    $("#block_sibportfolio_tmpl1").template(data).appendTo("#block_sibportfolio_sortlinks");
                    $(".block_sibportfolio_sortlink").on('click', click);
                    if (data.hasOwnProperty('not_found_label')) {
                        $("<div class='notification_label'></div>")
                            .text(data.not_found_label)
                            .wrap("<tr><td colspan='5'></td></tr>")
                            .parent().parent()
                            .appendTo("#block_sibportfolio_tablebody");
                    } else {
                        $("#block_sibportfolio_tmpl2").template(data).appendTo("#block_sibportfolio_tablebody");
                    }
                    $("#block_sibportfolio_pages").empty();
                    $("#block_sibportfolio_tmpl3").template(data).appendTo("#block_sibportfolio_pages");
                    $(".block_sibportfolio_pagebtn").on('click', click);
                    $(".block_sibportfolio_sortorder").attr('value', data.sortorder);
                },
                error: function () {
                    $(".block_sibportfolio_tablediv")
                        .text("{{ error_label }}")
                        .css({
                            color: "red",
                            "text-align": "center",
                            "font-size": "14pt",
                            "font-weight": "bold"
                        });
                },
                complete: function () {
                    $("#block_sibportfolio_load").hide();
                    handle = false;
                }
            });
        }

        var delay = (function () {
            var timer = 0;
            return function (callback, ms) {
                clearTimeout(timer);
                timer = setTimeout(callback, ms);
            };
        })();

        $(".block_sibportfolio_btngroup").hide();

        $('.block_sibportfolio_groupname').keyup(function (e) {
            delay(function () {
                click(e)
            }, 500);
        });
        $(".block_sibportfolio_sortlink").on('click', click);
        $(".block_sibportfolio_pagebtn").on('click', click);
        $("<div id='block_sibportfolio_load' class='notification_label'><img src='{{ wwwroot }}/blocks/sibportfolio/pix/loading.gif'>  {{ loading_label }}</div>")
            .appendTo(".block_sibportfolio_tablediv")
            .hide();

    });

    Handlebars.registerHelper("ifNotVisible", function (value, options) {
        if (value.visible == false)
            return options.fn(this);
        return options.inverse(this);
    });
</script>